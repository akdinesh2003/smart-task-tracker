<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Smart Task Tracker Pro - Enhanced</title>
<style>
  /* Reset & base styles */
  * {
    box-sizing: border-box;
  }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 20px;
    min-height: 100vh;
    background: linear-gradient(135deg, #a3b5c1, #7a8a99);
    display: flex;
    justify-content: center;
    align-items: flex-start;
    overflow-y: auto;
    color: #222;
    user-select: none;
    transition: background 0.6s ease;
  }
  /* Overlay for dim background */
  body::before {
    content: "";
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.15);
    backdrop-filter: blur(3px);
    z-index: -1;
    transition: background 0.6s ease;
  }
  body.dark {
    background: linear-gradient(135deg, #121212, #1a1a1a);
  }
  body.dark::before {
    background: rgba(0, 0, 0, 0.7);
  }

  #app {
    max-width: 600px;
    width: 100%;
    background: rgba(255, 255, 255, 0.95);
    padding: 25px 30px;
    border-radius: 15px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
    animation: fadeIn 1s ease forwards;
    user-select: text;
    position: relative;
  }
  @keyframes fadeIn {
    from {opacity: 0; transform: translateY(10px);}
    to {opacity: 1; transform: translateY(0);}
  }
  @keyframes fadeOut {
    from {opacity: 1;}
    to {opacity: 0;}
  }
  h1 {
    text-align: center;
    margin-bottom: 25px;
    font-weight: 700;
    letter-spacing: 1.5px;
    user-select: text;
  }
  form {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }
  form input[type="text"] {
    flex-grow: 2;
    padding: 12px 15px;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 8px;
    transition: border-color 0.3s ease;
  }
  form input[type="text"]:focus {
    border-color: #4f46e5;
    outline: none;
    box-shadow: 0 0 8px #4f46e5aa;
  }
  form input[type="date"],
  form select {
    padding: 12px 10px;
    font-size: 1rem;
    border: 1px solid #ccc;
    border-radius: 8px;
    width: 140px;
    transition: border-color 0.3s ease;
  }
  form input[type="date"]:focus,
  form select:focus {
    border-color: #4f46e5;
    outline: none;
    box-shadow: 0 0 8px #4f46e5aa;
  }
  form button {
    padding: 12px 25px;
    background: #4f46e5;
    border: none;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-size: 1.1rem;
    font-weight: 600;
    box-shadow: 0 5px 12px rgba(79, 70, 229, 0.6);
    transition: background 0.3s ease, box-shadow 0.3s ease;
    user-select: none;
  }
  form button:hover {
    background: #3730a3;
    box-shadow: 0 7px 20px rgba(55, 48, 163, 0.8);
  }

  #filterSearch {
    display: flex;
    justify-content: space-between;
    margin-bottom: 15px;
    flex-wrap: wrap;
    gap: 10px;
  }
  #filterSearch select, #filterSearch input[type="text"], #sortSelect {
    padding: 10px 12px;
    font-size: 1rem;
    border-radius: 8px;
    border: 1px solid #ccc;
    width: 48%;
    transition: border-color 0.3s ease;
  }
  #filterSearch select:focus,
  #filterSearch input[type="text"]:focus,
  #sortSelect:focus {
    border-color: #4f46e5;
    outline: none;
    box-shadow: 0 0 8px #4f46e5aa;
  }
  #clearAllBtn {
    background: #e11d48;
    color: white;
    border: none;
    border-radius: 8px;
    padding: 10px 18px;
    cursor: pointer;
    transition: background 0.3s ease, box-shadow 0.3s ease;
    width: 100%;
    font-weight: 600;
    margin-top: 10px;
    user-select: none;
  }
  #clearAllBtn:hover {
    background: #9f1239;
    box-shadow: 0 6px 16px rgba(159, 18, 57, 0.8);
  }

  ul#taskList {
    list-style: none;
    padding: 0;
    margin: 0;
    max-height: 420px;
    overflow-y: auto;
    border-top: 1px solid #eee;
    border-radius: 0 0 15px 15px;
  }
  ul#taskList li {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 18px;
    border-bottom: 1px solid #eee;
    cursor: grab;
    background: white;
    border-radius: 8px;
    margin-bottom: 10px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.07);
    transition: box-shadow 0.3s ease, transform 0.2s ease, opacity 0.5s ease;
    user-select: text;
    position: relative;
  }
  ul#taskList li.fade-out {
    animation: fadeOut 0.4s forwards;
  }
  ul#taskList li:hover {
    box-shadow: 0 6px 18px rgba(0, 0, 0, 0.15);
    transform: translateY(-3px);
  }
  ul#taskList li.dragging {
    opacity: 0.5;
    background: #e9ecef;
    box-shadow: none;
    cursor: grabbing;
    transform: none !important;
  }

  .task-info {
    display: flex;
    align-items: center;
    gap: 15px;
    flex-grow: 1;
    min-width: 0;
    flex-wrap: wrap;
  }
  .task-info input[type="checkbox"] {
    width: 20px;
    height: 20px;
    cursor: pointer;
    user-select: none;
  }
  .task-text {
    flex-grow: 1;
    font-size: 1rem;
    color: #222;
    word-break: break-word;
    user-select: text;
    outline-offset: 2px;
    min-width: 140px;
  }
  .task-text.completed {
    text-decoration: line-through;
    color: #999;
    user-select: none;
  }
  .task-due {
    font-size: 0.9rem;
    color: #555;
    min-width: 90px;
    text-align: center;
    user-select: text;
  }
  .task-due.overdue {
    color: #e11d48;
    font-weight: 700;
  }
  .priority {
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    min-width: 65px;
    text-align: center;
    user-select: none;
    color: white;
    text-transform: uppercase;
    letter-spacing: 0.6px;
  }
  .priority.High {
    background: #e11d48;
  }
  .priority.Medium {
    background: #f59e0b;
  }
  .priority.Low {
    background: #10b981;
  }

  .task-actions {
    display: flex;
    gap: 12px;
    align-items: center;
  }
  .task-actions button {
    background: transparent;
    border: none;
    cursor: pointer;
    font-size: 1.3rem;
    color: #666;
    transition: color 0.2s ease;
    user-select: none;
  }
  .task-actions button:hover {
    color: #4f46e5;
  }
  .task-actions button.delete-btn:hover {
    color: #e11d48;
  }
  .edit-input {
    font-size: 1rem;
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 6px;
    flex-grow: 1;
    user-select: text;
    outline-offset: 2px;
    min-width: 140px;
  }
  .notes-input {
    flex-basis: 100%;
    margin-top: 5px;
    font-size: 0.9rem;
    padding: 6px 8px;
    border-radius: 6px;
    border: 1px solid #ccc;
    resize: vertical;
  }

  /* Tags styling */
  .tags {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    margin-top: 6px;
  }
  .tag {
    background: #4f46e5;
    color: white;
    border-radius: 12px;
    padding: 2px 8px;
    font-size: 0.75rem;
    user-select: none;
  }

  /* Tooltip */
  #undoTooltip {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: #4f46e5;
    color: white;
    padding: 10px 18px;
    border-radius: 25px;
    box-shadow: 0 5px 15px rgba(79, 70, 229, 0.7);
    font-weight: 600;
    user-select: none;
    cursor: pointer;
    display: none;
    z-index: 999;
    transition: opacity 0.3s ease;
  }
  #undoTooltip.show {
    display: block;
    opacity: 1;
  }
  #undoTooltip.hide {
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  /* Modal Dashboard */
  #dashboardModal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    background: white;
    border-radius: 15px;
    padding: 20px 25px;
    max-width: 350px;
    width: 90%;
    box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease, transform 0.3s ease;
    z-index: 1000;
  }
  #dashboardModal.show {
    opacity: 1;
    pointer-events: auto;
    transform: translate(-50%, -50%) scale(1);
  }
  #dashboardModal h2 {
    margin-top: 0;
    text-align: center;
  }
  #dashboardModal ul {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  #dashboardModal ul li {
    margin: 8px 0;
    font-weight: 600;
    color: #4f46e5;
  }
  #dashboardModal button.close-btn {
    display: block;
    margin: 20px auto 0 auto;
    padding: 10px 20px;
    background: #4f46e5;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
  }
  #dashboardModal button.close-btn:hover {
    background: #3730a3;
  }

  /* Scrollbar */
  ul#taskList::-webkit-scrollbar {
    width: 8px;
  }
  ul#taskList::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.1);
    border-radius: 10px;
  }

  /* Responsive */
  @media (max-width: 480px) {
    form input[type="date"], form select, #filterSearch select, #filterSearch input[type="text"], #sortSelect {
      width: 100%;
    }
  }
</style>
</head>
<body>

<div id="app" role="main" aria-label="Smart Task Tracker Pro">

  <h1>Smart Task Tracker Pro</h1>

  <form id="taskForm" aria-label="Add new task form" autocomplete="off">
    <input type="text" id="taskInput" placeholder="Enter task..." aria-label="Task description" required />
    <input type="date" id="dueDateInput" aria-label="Due date" />
    <select id="priorityInput" aria-label="Select priority">
      <option value="Low">Low Priority</option>
      <option value="Medium" selected>Medium Priority</option>
      <option value="High">High Priority</option>
    </select>
    <button type="submit" aria-label="Add task">Add</button>
  </form>

  <div id="filterSearch">
    <select id="filterSelect" aria-label="Filter tasks">
      <option value="all">All Tasks</option>
      <option value="pending">Pending Tasks</option>
      <option value="completed">Completed Tasks</option>
    </select>
    <input type="text" id="searchInput" placeholder="Search tasks..." aria-label="Search tasks" />
  </div>

  <div id="filterSort" style="margin-bottom:15px;">
    <select id="sortSelect" aria-label="Sort tasks">
      <option value="created">Sort by Created (default)</option>
      <option value="priority">Sort by Priority</option>
      <option value="dueDate">Sort by Due Date</option>
      <option value="timeSpent">Sort by Time Spent</option>
    </select>
  </div>

  <ul id="taskList" aria-live="polite" aria-relevant="additions removals"></ul>

  <button id="clearAllBtn" aria-label="Clear all tasks">Clear All Tasks</button>
  <button id="exportBtn" style="margin-top:10px;background:#4f46e5;color:white;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;">Export Tasks</button>
  <input type="file" id="importFileInput" accept=".json" style="display:none;" />
  <button id="importBtn" style="margin-top:10px;background:#10b981;color:white;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;">Import Tasks</button>
  <button id="showDashboardBtn" style="margin-top:10px;background:#f59e0b;color:white;padding:10px 20px;border:none;border-radius:8px;cursor:pointer;">Show Progress Dashboard</button>
</div>

<div id="undoTooltip" role="alert" tabindex="0" aria-live="assertive" aria-atomic="true" aria-relevant="additions removals">
  Undo Delete
</div>

<div id="dashboardModal" role="dialog" aria-modal="true" aria-labelledby="dashboardTitle">
  <h2 id="dashboardTitle">Task Progress Dashboard</h2>
  <ul id="dashboardStats"></ul>
  <button class="close-btn" aria-label="Close dashboard">Close</button>
</div>

<audio id="reminderSound" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg" preload="auto"></audio>

<script>
  (() => {
    const taskForm = document.getElementById('taskForm');
    const taskInput = document.getElementById('taskInput');
    const dueDateInput = document.getElementById('dueDateInput');
    const priorityInput = document.getElementById('priorityInput');
    const taskList = document.getElementById('taskList');
    const filterSelect = document.getElementById('filterSelect');
    const searchInput = document.getElementById('searchInput');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const undoTooltip = document.getElementById('undoTooltip');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const importFileInput = document.getElementById('importFileInput');
    const sortSelect = document.getElementById('sortSelect');
    const showDashboardBtn = document.getElementById('showDashboardBtn');
    const dashboardModal = document.getElementById('dashboardModal');
    const dashboardStats = document.getElementById('dashboardStats');
    const dashboardCloseBtn = dashboardModal.querySelector('.close-btn');
    const reminderSound = document.getElementById('reminderSound');

    // Load tasks or empty array
    let tasks = JSON.parse(localStorage.getItem('tasks')) || [];

    // Undo state
    let lastDeleted = null;
    let undoTimeout = null;

    // Save to localStorage
    function saveTasks() {
      localStorage.setItem('tasks', JSON.stringify(tasks));
    }

    function isOverdue(dateStr) {
      if (!dateStr) return false;
      const today = new Date();
      today.setHours(0,0,0,0);
      const dueDate = new Date(dateStr);
      return dueDate < today;
    }

    function playReminderSound() {
      reminderSound.currentTime = 0;
      reminderSound.play().catch(()=>{});
    }

    // Show daily summary popup
    function showDailySummary() {
      const todayStr = new Date().toISOString().slice(0,10);
      const dueToday = tasks.filter(t => t.dueDate === todayStr && !t.completed).length;
      const completedYesterday = tasks.filter(t => {
        if (!t.completed) return false;
        if (!t.completedDate) return false;
        const compDate = new Date(t.completedDate).toISOString().slice(0,10);
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yStr = yesterday.toISOString().slice(0,10);
        return compDate === yStr;
      }).length;
      const urgent = tasks.filter(t => t.priority === 'High' && !t.completed).length;

      alert(`Daily Summary:\n\nTasks Due Today: ${dueToday}\nTasks Completed Yesterday: ${completedYesterday}\nUrgent Tasks Pending: ${urgent}`);
    }

    function renderTasks() {
      const filter = filterSelect.value;
      const search = searchInput.value.toLowerCase();
      const sortBy = sortSelect.value;

      let filtered = tasks.filter(task => {
        if (filter === 'completed') return task.completed;
        if (filter === 'pending') return !task.completed;
        return true;
      });

      filtered = filtered.filter(task => {
        if (!task.text) return false;
        if (!task.text.toLowerCase) return true;
        return task.text.toLowerCase().includes(search);
      });

      // Sorting
      filtered.sort((a,b) => {
        if(sortBy === 'priority') {
          const order = { High: 1, Medium: 2, Low: 3 };
          return order[a.priority] - order[b.priority];
        }
        else if(sortBy === 'dueDate') {
          if(!a.dueDate) return 1;
          if(!b.dueDate) return -1;
          return new Date(a.dueDate) - new Date(b.dueDate);
        }
        else if(sortBy === 'timeSpent') {
          return (a.timeSpent || 0) - (b.timeSpent || 0);
        }
        // Default 'created' order: no change needed
        return 0;
      });

      taskList.innerHTML = '';

      filtered.forEach((task, index) => {
        const li = document.createElement('li');
        li.setAttribute('draggable', 'true');
        li.dataset.index = index;

        li.addEventListener('dragstart', dragStart);
        li.addEventListener('dragover', dragOver);
        li.addEventListener('drop', drop);
        li.addEventListener('dragend', dragEnd);

        const taskInfo = document.createElement('div');
        taskInfo.className = 'task-info';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = task.completed;
        checkbox.setAttribute('aria-label', 'Mark task complete');
        checkbox.addEventListener('change', () => {
          const originalIndex = tasks.findIndex(t => t === task);
          if (originalIndex !== -1) {
            tasks[originalIndex].completed = checkbox.checked;
            if (checkbox.checked) tasks[originalIndex].completedDate = new Date().toISOString();
            else tasks[originalIndex].completedDate = null;
            saveTasks();
            renderTasks();
          }
        });

        const taskText = document.createElement('span');
        taskText.className = 'task-text';
        if (task.completed) taskText.classList.add('completed');
        taskText.textContent = task.text;
        taskText.tabIndex = 0;
        taskText.setAttribute('role', 'textbox');
        taskText.setAttribute('aria-label', 'Task description. Double click to edit.');

        taskText.addEventListener('dblclick', () => {
          const input = document.createElement('input');
          input.type = 'text';
          input.value = task.text;
          input.className = 'edit-input';
          taskInfo.replaceChild(input, taskText);
          input.focus();

          input.addEventListener('blur', () => {
            const val = input.value.trim();
            if (val) {
              const originalIndex = tasks.findIndex(t => t === task);
              if (originalIndex !== -1) {
                tasks[originalIndex].text = val;
                saveTasks();
                renderTasks();
              }
            } else {
              renderTasks();
            }
          });
          input.addEventListener('keydown', e => {
            if (e.key === 'Enter') input.blur();
            if (e.key === 'Escape') renderTasks();
          });
        });

        // Notes multiline textarea
        const notesInput = document.createElement('textarea');
        notesInput.placeholder = 'Add notes...';
        notesInput.className = 'notes-input';
        notesInput.value = task.notes || '';
        notesInput.setAttribute('aria-label', 'Task notes');
        notesInput.addEventListener('change', () => {
          const originalIndex = tasks.findIndex(t => t === task);
          if (originalIndex !== -1) {
            tasks[originalIndex].notes = notesInput.value;
            saveTasks();
          }
        });

        const dueDate = document.createElement('span');
        dueDate.className = 'task-due';
        if (task.dueDate) {
          dueDate.textContent = new Date(task.dueDate).toLocaleDateString();
          if (isOverdue(task.dueDate) && !task.completed) {
            dueDate.classList.add('overdue');
            playReminderSound();
          }
        } else {
          dueDate.textContent = '-';
          dueDate.style.color = '#aaa';
        }

        const priority = document.createElement('span');
        priority.className = `priority ${task.priority}`;
        priority.textContent = task.priority;

        // Tags display (optional, empty now)
        const tagsDiv = document.createElement('div');
        tagsDiv.className = 'tags';
        if(task.tags && task.tags.length) {
          task.tags.forEach(tag => {
            const tspan = document.createElement('span');
            tspan.className = 'tag';
            tspan.textContent = tag;
            tagsDiv.appendChild(tspan);
          });
        }

        taskInfo.appendChild(checkbox);
        taskInfo.appendChild(taskText);
        taskInfo.appendChild(dueDate);
        taskInfo.appendChild(priority);
        taskInfo.appendChild(tagsDiv);
        taskInfo.appendChild(notesInput);

        const actions = document.createElement('div');
        actions.className = 'task-actions';

        // Timer button
        const timerBtn = document.createElement('button');
        timerBtn.title = 'Start/Stop Timer';
        timerBtn.innerHTML = '&#9200;'; // clock emoji icon
        timerBtn.setAttribute('aria-label', 'Start or stop time tracking for task');
        let timerInterval = null;
        timerBtn.addEventListener('click', () => {
          if(timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
            timerBtn.style.color = '#666';
          } else {
            timerBtn.style.color = '#4f46e5';
            let start = Date.now();
            timerInterval = setInterval(() => {
              const elapsed = Date.now() - start;
              const seconds = Math.floor(elapsed / 1000);
              // store elapsed time in task (seconds)
              const originalIndex = tasks.findIndex(t => t === task);
              if(originalIndex !== -1) {
                tasks[originalIndex].timeSpent = (tasks[originalIndex].timeSpent || 0) + 1;
                saveTasks();
              }
            }, 1000);
          }
        });

        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.setAttribute('aria-label', 'Delete task');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = '&#10005;';
        deleteBtn.addEventListener('click', () => {
          if (confirm('Are you sure you want to delete this task?')) {
            const originalIndex = tasks.findIndex(t => t === task);
            if (originalIndex !== -1) {
              // Animate fade out before deleting
              const liEl = deleteBtn.closest('li');
              liEl.classList.add('fade-out');
              setTimeout(() => {
                lastDeleted = { item: tasks[originalIndex], index: originalIndex };
                tasks.splice(originalIndex, 1);
                saveTasks();
                renderTasks();
                showUndoTooltip();
              }, 400);
            }
          }
        });

        actions.appendChild(timerBtn);
        actions.appendChild(deleteBtn);

        li.appendChild(taskInfo);
        li.appendChild(actions);

        taskList.appendChild(li);
      });
    }

    // Drag and drop
    let dragSrcIndex = null;
    function dragStart(e) {
      this.classList.add('dragging');
      dragSrcIndex = Number(this.dataset.index);
      e.dataTransfer.effectAllowed = 'move';
    }
    function dragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      const target = e.currentTarget;
      if (!target.classList.contains('dragging')) {
        target.style.borderTop = (e.offsetY < target.clientHeight / 2) ? '2px solid #4f46e5' : '2px solid transparent';
        target.style.borderBottom = (e.offsetY >= target.clientHeight / 2) ? '2px solid #4f46e5' : '2px solid transparent';
      }
    }
    function dragEnd(e) {
      this.classList.remove('dragging');
      document.querySelectorAll('#taskList li').forEach(li => {
        li.style.borderTop = '';
        li.style.borderBottom = '';
      });
    }
    function drop(e) {
      e.preventDefault();
      const target = e.currentTarget;
      if (target.classList.contains('dragging')) return;

      let dragTargetIndex = Number(target.dataset.index);
      if (e.offsetY >= target.clientHeight / 2) {
        dragTargetIndex++;
      }
      if (dragTargetIndex > tasks.length -1) dragTargetIndex = tasks.length -1;

      if (dragSrcIndex !== null && dragSrcIndex !== dragTargetIndex) {
        const movedTask = tasks.splice(dragSrcIndex, 1)[0];
        tasks.splice(dragTargetIndex > dragSrcIndex ? dragTargetIndex -1 : dragTargetIndex, 0, movedTask);
        saveTasks();
        renderTasks();
      }
      dragSrcIndex = null;
    }

    // Undo tooltip logic
    function showUndoTooltip() {
      undoTooltip.classList.add('show');
      undoTooltip.focus();
      if(undoTimeout) clearTimeout(undoTimeout);
      undoTimeout = setTimeout(() => {
        undoTooltip.classList.remove('show');
      }, 5000);
    }
    undoTooltip.addEventListener('click', () => {
      if(lastDeleted) {
        tasks.splice(lastDeleted.index, 0, lastDeleted.item);
        saveTasks();
        renderTasks();
        lastDeleted = null;
        undoTooltip.classList.remove('show');
      }
    });

    // Add task event
    taskForm.addEventListener('submit', e => {
      e.preventDefault();

      const text = taskInput.value.trim();
      if (!text) {
        alert('Please enter a task description.');
        return;
      }

      const dueDate = dueDateInput.value || null;
      const priority = priorityInput.value;

      tasks.push({
        text,
        dueDate,
        priority,
        completed: false,
        timeSpent: 0,
        tags: [],
        notes: '',
      });

      saveTasks();
      renderTasks();

      taskInput.value = '';
      dueDateInput.value = '';
      priorityInput.value = 'Medium';
      taskInput.focus();
    });

    // Filter & Search & Sort events
    filterSelect.addEventListener('change', renderTasks);
    searchInput.addEventListener('input', renderTasks);
    sortSelect.addEventListener('change', renderTasks);

    // Clear all tasks button
    clearAllBtn.addEventListener('click', () => {
      if (tasks.length === 0) {
        alert('No tasks to clear.');
        return;
      }
      if (confirm('Are you sure you want to clear all tasks?')) {
        lastDeleted = { allItems: tasks.slice() };
        tasks = [];
        saveTasks();
        renderTasks();
        showUndoTooltip();
      }
    });

    // Export tasks
    exportBtn.addEventListener('click', () => {
      if(tasks.length === 0) {
        alert('No tasks to export.');
        return;
      }
      const dataStr = JSON.stringify(tasks, null, 2);
      const blob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `tasks_${new Date().toISOString().slice(0,10)}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    });

    // Import tasks
    importBtn.addEventListener('click', () => {
      importFileInput.click();
    });
    importFileInput.addEventListener('change', () => {
      const file = importFileInput.files[0];
      if(!file) return;
      const reader = new FileReader();
      reader.onload = e => {
        try {
          const imported = JSON.parse(e.target.result);
          if(Array.isArray(imported)) {
            tasks = tasks.concat(imported);
            saveTasks();
            renderTasks();
            alert('Tasks imported successfully.');
          } else {
            alert('Invalid file format.');
          }
        } catch {
          alert('Failed to read file.');
        }
      };
      reader.readAsText(file);
      importFileInput.value = '';
    });

    // Show Dashboard Modal
    showDashboardBtn.addEventListener('click', () => {
      updateDashboard();
      dashboardModal.classList.add('show');
      dashboardModal.focus();
    });
    dashboardCloseBtn.addEventListener('click', () => {
      dashboardModal.classList.remove('show');
    });

    // Update dashboard stats
    function updateDashboard() {
      const total = tasks.length;
      const completed = tasks.filter(t => t.completed).length;
      const pending = total - completed;
      const highPriority = tasks.filter(t => t.priority === 'High').length;
      const mediumPriority = tasks.filter(t => t.priority === 'Medium').length;
      const lowPriority = tasks.filter(t => t.priority === 'Low').length;
      const totalTime = tasks.reduce((sum,t) => sum + (t.timeSpent || 0), 0);

      dashboardStats.innerHTML = `
        <li>Total Tasks: ${total}</li>
        <li>Completed Tasks: ${completed}</li>
        <li>Pending Tasks: ${pending}</li>
        <li>High Priority: ${highPriority}</li>
        <li>Medium Priority: ${mediumPriority}</li>
        <li>Low Priority: ${lowPriority}</li>
        <li>Total Time Spent: ${Math.floor(totalTime/60)} min</li>
      `;
    }

    // Auto dark mode toggle based on time
    function autoDarkMode() {
      const hour = new Date().getHours();
      if(hour >= 19 || hour < 6) {
        document.body.classList.add('dark');
      } else {
        document.body.classList.remove('dark');
      }
    }
    setInterval(autoDarkMode, 60000);
    autoDarkMode();

    // Initial render
    renderTasks();

    // Show daily summary once on load (with timeout to avoid blocking UI immediately)
    setTimeout(showDailySummary, 1000);

    // Accessibility: Keyboard shortcut Ctrl+Z to undo
    window.addEventListener('keydown', e => {
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'z') {
        if(lastDeleted) {
          tasks.splice(lastDeleted.index || 0, 0, lastDeleted.item || []);
          saveTasks();
          renderTasks();
          lastDeleted = null;
          undoTooltip.classList.remove('show');
        }
      }
    });
  })();
</script>

</body>
</html>
